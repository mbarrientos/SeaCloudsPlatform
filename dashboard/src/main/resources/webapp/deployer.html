<!DOCTYPE html>
<!--

    Copyright 2014 SeaClouds
    Contact: SeaClouds

       Licensed under the Apache License, Version 2.0 (the "License");
       you may not use this file except in compliance with the License.
       You may obtain a copy of the License at

           http://www.apache.org/licenses/LICENSE-2.0

       Unless required by applicable law or agreed to in writing, software
       distributed under the License is distributed on an "AS IS" BASIS,
       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
       See the License for the specific language governing permissions and
       limitations under the License.

-->
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>SeaClouds Dashboard - Deployer</title>

    <link rel="shortcut icon" href="img/favicon.png">

    <!-- Core CSS - Include with every page -->
    <link href="css/lib/bootstrap.min.css" rel="stylesheet">
    <link href="css/lib/font-awesome.min.css" rel="stylesheet">


    <!-- SB Admin CSS - Include with every page -->
    <link href="css/sb-admin.css" rel="stylesheet">

    <!-- Code Mirror CSS -->
    <link rel="stylesheet" href="css/lib/codemirror.css">
    <link rel="stylesheet" href="css/lib/codemirror-simplescrollbars.css">

    <!-- PNotify CSS -->
    <link href="css/lib/pnotify.custom.min.css" rel="stylesheet">

</head>

<body>

<div id="wrapper">

    <nav class="navbar navbar-default navbar-fixed-top" role="navigation"
         style="margin-bottom: 0">
        <div class="navbar-header">
            <a class="navbar-brand extrnLink"
               href="http://www.seaclouds-project.eu/"> <img
                    class="img-responsive " src="img/seaclouds-header.png"
                    style="max-width: 100px; margin-top: -18px;" alt="SeaClouds project main website">
            </a>
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target=".sidebar-collapse">
                <span class="sr-only">Toggle navigation</span> <span
                    class="icon-bar"></span> <span class="icon-bar"></span> <span
                    class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html">SeaClouds Dashboard</a>
        </div>
        <!-- /.navbar-header -->

        <!-- TODO: Get alert number from Monitoring API -->
        <ul class="nav navbar-top-links navbar-right">

            <li id="loading-spinner"></li>
            <li class="divider"></li>
            <li class="divider"></li>
            <li class="divider"></li>


            <li class="dropdown"><a class="dropdown-toggle"
                                    data-toggle="dropdown" href="#"><span class="badge">0</span><i
                    class="fa fa-bell fa-fw"></i> <i class="fa fa-caret-down"></i> </a>
                <ul class="dropdown-menu dropdown-alerts">
                    <li><a href="#">
                        <div>
                            <i class="fa fa-exclamation fa-fw"></i>This feature will be
                            available in prior releases<span
                                class="pull-right text-muted small">Just now</span>
                        </div>
                    </a></li>
                    <li class="divider"></li>

                    <!-- TODO: Open all alerts page -->
                    <li class="disabled"><a class="text-center" href="#"> <strong>See
                        All Alerts</strong> <i class="fa fa-angle-right"></i>
                    </a></li>
                </ul>
            </li>
            <!-- /.dropdown-alerts -->
            <!-- /.dropdown -->
            <li class="dropdown"><a class="dropdown-toggle"
                                    data-toggle="dropdown" href="#"> <i class="fa fa-user fa-fw"></i>
                <i class="fa fa-caret-down"></i>
            </a>
                <ul class="dropdown-menu dropdown-user">
                    <li class="disabled"><a href="#"><i
                            class="fa fa-user fa-fw"></i>User Profile</a></li>
                    <li class="disabled"><a href="#"><i
                            class="fa fa-gear fa-fw"></i>Settings</a></li>
                    <li class="divider"></li>
                    <li><a href="#"><i class="fa fa-exclamation fa-fw"></i>
                        This feature will be available in prior releases</a></li>
                </ul>
                <!-- /.dropdown-user --></li>
            <!-- /.dropdown -->
        </ul>
        <!-- /.navbar-top-links -->

        <div class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="side-menu">
                    <li><a href="index.html"><i class="fa fa-dashboard fa-home"></i>&nbsp;Home</a></li>
                    <li><a href="module-profile-designer.html" class=""><i class="fa fa-pencil-square-o"></i>&nbsp;Module
                        Profile Designer</a></li>
                    <li><a href="discoverer-and-planner.html" class=""><i class="fa fa-code-fork"></i>&nbsp;Discoverer &
                        Planner</a></li>
                    <li><a href="deployer.html" class=""><strong><i
                            class="fa fa-download"></i>&nbsp;Deployer</strong></a></li>
                    <li><a href="monitor.html" class=""><i class="fa fa-dashboard"></i>&nbsp;Monitor</a></li>
                    <li><a href="sla.html" class=""><i class="fa fa-file-text-o"></i>&nbsp;SLA Service</a></li>

                </ul>
                <!-- /#side-menu -->
            </div>
            <!-- /.sidebar-collapse -->
        </div>
        <!-- /.navbar-static-side -->
    </nav>

    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h1 class="page-header">
                    Deployer
                    <small>Manage your Applications</small>
                </h1>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <!-- /.row -->
        <div id="page-content">
            <div class="row">

                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div id="app-status-heading" class="panel-heading">
                            <i class="fa fa-cloud-download"></i> Deploy a new application defined in CAMP YAML format
                            <a aria-expanded="false" data-toggle="collapse" data-parent="#accordion"
                               data-target="#app-status-collapsable"><i class="fa fa-chevron-down"></i></a>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-collapse collapse " id="app-status-collapsable">
                            <div class="panel-body" id="yaml-input-panel-body">
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="form-group" id="text-form-group">
                                                <label for="yaml-input-textarea">Paste your YAML here</label>
                                                <textarea id="yaml-input-textarea" class="form-control" rows="3"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="form-group" id="file-form-group">
                                                <label for="yaml-input-file">Choose a YAML File</label>
                                                <input type="file" id="yaml-input-file">
                                            </div>
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="pull-right">
                                                <button  class="btn btn-primary" onClick="submitYaml()">Deploy</button>
                                            </div>
                                        </div>
                                    </div>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-lg-12">

                    <h4><i class="fa fa-laptop"></i> Running applications</h4>
                    <!-- /.panel-heading -->

                    <div id="deployed-applications" >
                        <div class="panel-body">
                            <p>Currently no applications are deployed...</p>
                        </div>
                    </div>

                </div>

            </div>
            <h4><i class="fa fa-file-text"></i> Monitoring & SLA configuration</h4>
            <!-- /.row -->
            <div class="row">
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading" id="monitoring-rules-heading">
                            <i class="fa fa-dashboard"></i> Monitoring rules
                            <a aria-expanded="false" data-toggle="collapse" data-parent="#accordion"
                               data-target="#monitoring-rules-collapsable"><i class="fa fa-chevron-down"></i></a>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-collapse collapse" id="monitoring-rules-collapsable">
                            <div class="panel-body">
                                <form id="form-monitoring-rules" class="form-horizontal" role="form">
                                    <div class="form-group">
                                        <div class="col-lg-12">
                                            <textarea id="textarea-monitoring-rules" class="form-control" style="resize: none"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label for="file-monitoring-rules">Upload a file</label>
                                            <input type="file" id="file-monitoring-rules">
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="button-wrapper pull-right" style="padding: 7px">
                                                <button type="button" class="btn btn-primary" onclick="processMonitoringRules()">
                                                    Load plan
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading" id="deployment-model-heading">
                            <i class="fa fa-dashboard"></i> Deployment model (Monitoring platform)
                            <a aria-expanded="false" data-toggle="collapse" data-parent="#accordion"
                               data-target="#deployment-model-collapsable"><i class="fa fa-chevron-down"></i></a>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-collapse collapse" id="deployment-model-collapsable">
                            <div class="panel-body">
                                <form id="form-deployment-model" class="form-horizontal" role="form">
                                    <div class="form-group">
                                        <div class="col-lg-12">
                                            <textarea id="textarea-deployment-model" class="form-control" style="resize: none"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label for="file-deployment-model">Upload a file</label>
                                            <input type="file" id="file-deployment-model">
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="button-wrapper pull-right" style="padding: 7px">
                                                <button type="button" class="btn btn-primary" onclick="processDeploymentModel()">
                                                    Load model
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row"> 
                <div class="col-lg-6">
                    <div class="panel panel-default">
                        <div class="panel-heading" id="sla-agreements-heading">
                            <i class="fa fa-dashboard"></i> SLA Agreements
                            <a aria-expanded="false" data-toggle="collapse" data-parent="#accordion"
                               data-target="#sla-agreements-collapsable"><i class="fa fa-chevron-down"></i></a>
                        </div>
                        <!-- /.panel-heading -->
                        <div class="panel-collapse collapse" id="sla-agreements-collapsable">
                            <div class="panel-body">
                                <form id="form-sla-agreements" class="form-horizontal" role="form">
                                    <div class="form-group">
                                        <div class="col-lg-12">
                                            <textarea id="textarea-sla-agreements" class="form-control" style="resize: none"></textarea>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-lg-6">
                                            <label for="file-sla-agreement">Upload a file</label>
                                            <input type="file" id="file-sla-agreement">
                                        </div>
                                        <div class="col-lg-6">
                                            <div class="button-wrapper pull-right" style="padding: 7px">
                                                <button type="button" class="btn btn-primary" onclick="processSlaAgreements()">
                                                    Load agreements
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<!-- Core Scripts - Include with every page -->
<script src="js/lib/jquery-1.10.2.js"></script>
<script src="js/lib/jquery.metisMenu.js"></script>
<script src="js/lib/bootstrap.min.js"></script>
<script src="js/lib/spin.min.js"></script>

<!-- SB Admin Scripts - Include with every page -->
<script src="js/sb-admin.js"></script>

<!-- Code Mirror Scripts -->
<script src="js/lib/codemirror-compressed.js"></script>

<!-- PNotify Scripts -  -->
<script src="js/lib/pnotify.custom.min.js"></script>

<script type="text/javascript">
    var SPINNER = new Spinner({lines: 13, length: 6, width: 2, radius: 5, top: "-5px"}).spin(document.getElementById("loading-spinner"));
    var CONTENT_ID = "deployed-applications";
    var APP_DEPLOYER_TEXTAREA;
    var MONITORING_RULES_TEXTAREA;
    var DEPLOYMENT_MODEL_TEXTAREA;
    var SLA_AGREEMENTS_TEXTAREA;

    $(document).ready(function () {
        $("#app-status-heading").on("click", function () {
            $("#app-status-collapsable").collapse("toggle");
        });
        $("#monitoring-rules-heading").on("click", function () {
            $("#monitoring-rules-collapsable").collapse("toggle");
        });
        $("#deployment-model-heading").on("click", function () {
            $("#deployment-model-collapsable").collapse("toggle");
        });
        $("#sla-agreements-heading").on("click", function () {
            $("#sla-agreements-collapsable").collapse("toggle");
        });
        PNotify.prototype.options.styling = "fontawesome";

        setupTextArea();
        updatePage();
        setInterval(updatePage, 10000);
    });

    function setupTextArea() {
        var appDeployer = document.getElementById("yaml-input-textarea");
        APP_DEPLOYER_TEXTAREA = CodeMirror.fromTextArea(appDeployer, {scrollbarStyle: "simple", tabSize: 2});
        APP_DEPLOYER_TEXTAREA.setSize("100%", 300);

        var monitoringRules = document.getElementById("textarea-monitoring-rules");
        MONITORING_RULES_TEXTAREA = CodeMirror.fromTextArea(monitoringRules, {scrollbarStyle: "simple", tabSize: 2, mode:"xml"})
        MONITORING_RULES_TEXTAREA.setSize("100%", 400);
        MONITORING_RULES_TEXTAREA.setValue("Paste here an XML containing the Monitoring Rules");

        var deploymentModel = document.getElementById("textarea-deployment-model");
        DEPLOYMENT_MODEL_TEXTAREA = CodeMirror.fromTextArea(deploymentModel, {scrollbarStyle: "simple", tabSize: 2, mode:"xml"})
        DEPLOYMENT_MODEL_TEXTAREA.setSize("100%", 400);
        DEPLOYMENT_MODEL_TEXTAREA.setValue("Paste here an XML containing the Deployment Model for the Monitor Component");

        var slaAgreements = document.getElementById("textarea-sla-agreements");
        SLA_AGREEMENTS_TEXTAREA = CodeMirror.fromTextArea(slaAgreements, {scrollbarStyle: "simple", tabSize: 2, mode:"xml"})
        SLA_AGREEMENTS_TEXTAREA.setSize("100%", 400);
        SLA_AGREEMENTS_TEXTAREA.setValue("Paste here an XML containing the SLA Agreements");


        $("#app-status-collapsable").on('shown.bs.collapse', function() {
            if(APP_DEPLOYER_TEXTAREA.getValue().length==0){
                APP_DEPLOYER_TEXTAREA.setValue("");
            }
            APP_DEPLOYER_TEXTAREA.focus();
        });

        $("#yaml-input-file").on("change", function(){
            var unparsedFile = $("#yaml-input-file").prop('files')[0];
            var reader = new FileReader();

            reader.onload = function (theFile) {
                APP_DEPLOYER_TEXTAREA.setValue(theFile.target.result);
            }
            reader.readAsText(unparsedFile);
        })
    }

    function updatePage() {
        SPINNER.spin(document.getElementById("loading-spinner"));
        displayApplicationOverview();
    }

    // Deployed applications

    function displayApplicationOverview() {
        var boxHTML = "";
        $.get("api/deployer/applications", function getApplications(response) {
            if (response.length > 0) {
                $.each(response, function (appIdx, app) {
                    boxHTML += generateAppOverviewBox(app);
                })
            } else {
                boxHTML = "<h1 class=\"text-center text-warning\">No applications running.</h1>";
            }
        }).done(function () {
            $('#' + CONTENT_ID).html(boxHTML);
        }).fail(function () {
            boxHTML = "<h1 class=\"text-center text-danger\">Deployer module is not available in this moment.</h1>";
            $('#page-content').html(boxHTML)
        }).always(function () {
            $('#' + CONTENT_ID).show();
            SPINNER.stop();
        });
    }

    function generateAppOverviewBox(application) {
        // External container
        var appHTML = "<div class=\"col-lg-6\"><div class=\"panel panel-default\">";

        // Header
        appHTML += "<div class=\"panel-heading clearfix\">";
        appHTML += "<i class=\"fa fa-gears fa-fw\"><\/i> " + application.name +
                "<button type=\"button\" class=\"btn btn-danger navbar-right\" onClick=deleteApp('" + application.id + "')>Remove</button>";
        appHTML += "</div>";

        // Body
        appHTML += "<div class=\"panel-body\" id=\"information-panel\">";
        appHTML += "<strong>ID: </strong> " +  application.id + "<br>";
        appHTML += "<strong>Name: </strong> " +  application.name + "<br>";
        appHTML += "<strong>Type: </strong> " +  application.type  + "<br>";

        if(application.serviceState == "running"){
            appHTML += "<strong>Status: </strong> <span class=\"text-success\">" +  application.serviceState + "</span><br>";
        } else if(application.serviceState == "starting"){
            appHTML += "<strong>Status: </strong> <span class=\"text-muted\">" +  application.serviceState + "</span><br>";
        }else{
            appHTML += "<strong>Status: </strong> <span class=\"text-danger\">" +  application.serviceState + "</span><br>";
        }

        appHTML += "<ul class=\"list-unstyled\"><li><strong>Application Components</strong></li>";
        application.children.forEach(function(child){
            appHTML += "<li role=\"presentation\" class=\"dropdown-header\">" +
                    "<a href=\"#\" data-toggle=\"collapse\" class=\"active\" data-target=\"#" + child.id + "-collapse\">" +
                    "<i class=\"fa fa-search\"></i> " + child.name + " Summary  <i class=\"fa fa-angle-down\"></i></a></li>";

            var collapseStatus = $("#" +child.id + "-collapse");
            if(collapseStatus && collapseStatus.hasClass("in")){
                appHTML += "<li id=\"" + child.id + "-collapse\" class=\"collapse in\">";
            }else{
                appHTML += "<li id=\"" + child.id + "-collapse\" class=\"collapse\">";
            }

            appHTML += "<ul  class=\"list-unstyled\" style=\"padding-left : 5%\">";
            appHTML += "<li><i class=\"fa fa-chevron-right\"></i> <strong>ID: </strong>" + child.id + "</li>";
            appHTML += "<li><i class=\"fa fa-chevron-right\"></i> <strong>Name: </strong>" + child.name + "</li>";
            appHTML += "<li><i class=\"fa fa-chevron-right\"></i> <strong>Type: </strong>" + child.type + "</li>";
            appHTML += "<li role=\"presentation\" class=\"dropdown-header\">" +
                    "<a href=\"#\" data-toggle=\"collapse\" class=\"active\" data-target=\"#" + child.id + "-locations-collapse\">" +
                    "<i class=\"fa fa-map-marker\"></i> Locations <i class=\"fa fa-angle-down\"></i></a>" ;

            collapseStatus = $("#" +child.id + "-locations-collapse");
            if(collapseStatus && collapseStatus.hasClass("in")){
                appHTML += "<li id=\"" + child.id + "-locations-collapse\" class=\"collapse in\">";
            }else{
                appHTML += "<li id=\"" + child.id + "-locations-collapse\" class=\"collapse\">";
            }

            appHTML += "<ul  class=\"list-unstyled\" style=\"padding-left : 5%\">";

            child.locations.forEach(function(location){
                appHTML += "<li><i class=\"fa fa-chevron-right\"></i> <strong>Name: </strong>" + location.spec + "</li><br/>";
            })

            appHTML += "</ul>";
            appHTML += "</li>";
            appHTML += "</ul>";

        })
        appHTML += "</ul>"
        appHTML +="<br>";
        appHTML += "</div>";

        // External container
        appHTML += "</div>";
        appHTML += "</div>";

        return appHTML
    }


    function deleteApp(applicationId) {
        // http://stackoverflow.com/a/15089299
        SPINNER.spin(document.getElementById("loading-spinner"));
        $.ajax({
            url: "api/deployer/application" + "?" + $.param({id: applicationId}),
            type: 'DELETE'
        }).done(function(){
            new PNotify({
                title: 'App removed successfully',
                text: 'Please wait until the application list refreshes',
                type: 'success'
            });
            setTimeout(function(){
                updatePage();
            }, 1000);
        }).fail(function (){
            new PNotify({
                title: 'Error',
                text: 'Something happened while removing the application',
                type: 'error'
            });
        }).always(function(){
            SPINNER.stop();
        })

        return false;
    }

    function submitYaml() {
        SPINNER.spin(document.getElementById("loading-spinner"));
        $("#app-status-collapsable").collapse("toggle");

        var query= $.post("api/deployer/applications", APP_DEPLOYER_TEXTAREA.getValue());
        query.done(function () {
            APP_DEPLOYER_TEXTAREA.setValue(" ");
            new PNotify({
                title: 'App deployed successfully',
                text: 'It will appear soon on the application list',
                type: 'success'
            });
            setTimeout(function(){
                updatePage();
            }, 1000);
        }).fail(function () {
            new PNotify({
                title: 'Error',
                text: 'Something happened while deploying the application',
                type: 'error'
            });
        }).always(function(){
            SPINNER.stop();
        })
        return false;
    }


    function processMonitoringRules() {
        SPINNER.spin(document.getElementById("loading-spinner"));

        $.post("api/monitor/rules", {rules: MONITORING_RULES_TEXTAREA.getValue()}, function sendMonitoringRules(response) {
            SPINNER.stop();
        }).done(function () {
            new PNotify({
                title: 'Setup of monitoring rules was successful',
                text: 'The rest of the modules will be notified soon',
                type: 'success'
            });
        }).fail(function () {
            new PNotify({
                title: 'Error',
                text: 'Error processing the monitoring rules',
                type: 'error'
            });
            SPINNER.stop();
        });
    }
    function processDeploymentModel() {
        SPINNER.spin(document.getElementById("loading-spinner"));

        $.post("api/monitor/rules", {rules: MONITORING_RULES_TEXTAREA.getValue()}, function sendDeploymentModel(response) {
            SPINNER.stop();
        }).done(function () {
            new PNotify({
                title: 'Setup of deployment model was successful',
                text: 'The rest of the modules will be notified soon',
                type: 'success'
            });
        }).fail(function () {
            new PNotify({
                title: 'Error',
                text: 'Error processing the deployment model',
                type: 'error'
            });
            SPINNER.stop();
        });
    }
    function processSlaAgreements() {
        SPINNER.spin(document.getElementById("loading-spinner"));

        if (MONITORING_RULES_TEXTAREA.getValue() == ""){
            new PNotify({
                title: 'Missing monitoring rules',
                text: 'Monitoring rules are necessary for SLA initialization',
                type: 'error'
            })
        } else if (SLA_AGREEMENTS_TEXTAREA.getValue() == ""){
            new PNotify({
                title: 'Missing SLA agreements',
                text: 'SLA agreements field is mandatory',
                type: 'error'
            })
        } else {
            $.ajax({
                url: "api/sla/agreements",
                data: {agreements: SLA_AGREEMENTS_TEXTAREA.getValue(), rules: MONITORING_RULES_TEXTAREA.getValue()},
                type: 'POST'
            }).done(function(res) {
                new PNotify({
                    title: 'SLA agreements were added successfully',
                    text: 'It will appear soon on the application list',
                    type: 'success'
                });
            }).fail(function(res) {
                new PNotify({
                    title: 'Error',
                    text: 'Error processing the SLA Agreements',
                    type: 'error'
                });
            }).always(function(res){
                SPINNER.stop();
            });
        }
    }

</script>
</body>


</html>
